<!--

    ShinyProxy

    Copyright (C) 2016-2021 Open Analytics

    ===========================================================================

    This program is free software: you can redistribute it and/or modify
    it under the terms of the Apache License as published by
    The Apache Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    Apache License for more details.

    You should have received a copy of the Apache License
    along with this program.  If not, see <http://www.apache.org/licenses/>

-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head lang="en">
	<title th:text="${appTitle} + ' - ' + ${appInstanceDisplayName}"></title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<link rel="stylesheet" media="screen" th:href="@{${bootstrapCss} + ${resourceSuffix}}" />
	<link rel="stylesheet" media="screen" th:href="@{'/css/default.css' + ${resourceSuffix}}"/>
	<script th:src="@{${jqueryJs} + ${resourceSuffix}}"></script>
	<script th:src="@{${bootstrapJs} + ${resourceSuffix}}"></script>
	<script th:src="@{${handlebars} + ${resourceSuffix}}"></script>
	<script th:src="@{${cookieJs} + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.app.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.api.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.connections.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.instances.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.ui.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/js/shiny.common.js' + ${resourceSuffix}}"></script>
	<script th:if="${operatorEnabled}" th:src="@{'/js/shiny.operator.js' + ${resourceSuffix}}"></script>
	<script th:src="@{'/handlebars/precompiled.js' + ${resourceSuffix}}"></script>

</head>
<body id="appPage">
	<div th:replace="fragments/navbar :: navbar"></div>

    <div id="iframeinsert"></div>
	<div id="new-version-banner" class="alert alert-info" role="alert" style="display:none;">
		<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		A new version of <span th:text="${application_name}"></span> is available <button id="new-version-btn" class="btn btn-default btn-sm" >Switch to new version!</button>
	</div>
    <div id="loading" class="loading loading-img"><div class="loading-txt">Launching <span th:text="${appTitle}"></span>...</div></div>
	<div id="reconnecting" class="loading loading-img">
		<div class="loading-txt">
			Reconnecting to <span th:text="${appTitle}"></span>...
			<span class="retryingDetails">
				<br>
				Attempt <span class="reloadAttempts"></span>/<span class="maxReloadAttempts"></span>
				<br>
				Retrying <span id="retryInXSeconds">in <span class="retrySeconds"></span></span><span id="retryNow">now</span>
			</span>
		</div>
	</div>
	<div id="reloadFailed" class="loading loading-img">
		<div class="loading-txt">
			Failed to reload <span th:text="${appTitle}"></span><br><br>
			<span class="refreshButton">
				<button onClick="window.location.reload()" class="btn btn-default">Refresh page</button>
			</span>
		</div>
	</div>
	<div id="appStopped" class="loading">
		<div class="loading-txt">
			This app has been stopped, you can now close this tab.<br><br>
			<span class="refreshButton">
				<button onClick="window.location.reload()" class="btn btn-default btn-restart-app">Restart app</button>
			</span>
		</div>
	</div>
	<div id="userLoggedOut" class="loading">
		<div class="loading-txt">
			You logged out using another browser tab, you can now close this tab.<br><br>
			<span class="refreshButton">
				<a th:href="@{/}" class="btn btn-default">Login again</a>
			</span>
		</div>
	</div>
    <div id="parameterForm">
        <div class="container">
            <div class="row">
                <h2>Choose the parameters for this app</h2>
            </div>
            <div class="row" id="selectAllWarning">
                <div class="alert alert-danger" role="alert">Please select a value for each parameter before starting the app!</div>
            </div>
            <div class="row">
                <form class="form-horizontal">
                    <div class="form-group" th:each="parameterDefinition : ${parameterDefinitions}">
                        <label th:for="${'parameter-' + parameterDefinition.getId()}" class="col-sm-2 control-label" th:text="${parameterDefinition.getDisplayNameOrId()}"></label>
                        <div class="col-sm-10">
                            <select th:id="${'parameter-' + parameterDefinition.getId()}" th:name="${parameterDefinition.getId()}" class="form-control" th:disabled="${parameterDefinition != parameterDefinitions.get(0)}">
                                <option disabled selected>Select an option</option>
                                <option th:each="value : ${parameterValues.get(parameterDefinition.id)}"  th:text="${value}"></option>
                            </select>
                            <span class="help-block" th:if="${parameterDefinition.getDescription() != null}" th:text="${parameterDefinition.getDescription()}"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-default btn-success">Start</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

	<div th:replace="fragments/switch-instance-modal :: switch-instance-modal"></div>

	<script type="text/javascript" th:inline="javascript">
		$(window).on('load', function() {
		    window.Shiny.common.init([[${contextPath}]], [[${application_name}]], [[${spInstance}]], [[${appMaxInstances}]]);
			if ([[${operatorEnabled}]]) {
				window.Shiny.operator.init([[${operatorForceTransfer}]], [[${operatorShowTransferMessage}]]);
			}
			window.Shiny.app.start(
					[[${containerPath}]],
					[[${webSocketReconnectionMode}]],
					[[${proxyId}]],
					[[${heartbeatRate}]],
					[[${appName}]],
					[[${appInstance}]],
					[[${shinyForceFullReload}]],
					[[${spInstanceOverride}]],
                    [[${parameterAllowedCombinations}]],
                    [[${parameterDefinitions}]],
                    [[${parameterIds}]]
			);
		});
	</script>
</body>
</html>
